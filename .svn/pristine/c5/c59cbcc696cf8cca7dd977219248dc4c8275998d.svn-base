package com.super_bits.modulosSB.Persistencia.registro.persistidos;

import com.super_bits.modulosSB.Persistencia.Campo.CampoMultiplo;
import com.super_bits.modulosSB.Persistencia.dao.UtilSBPersistencia;
import com.super_bits.modulosSB.SBCore.ConfigGeral.SBCore;
import com.super_bits.modulosSB.SBCore.InfoCampos.campo.CampoEsperado;
import com.super_bits.modulosSB.SBCore.InfoCampos.registro.ItemGenerico;
import com.super_bits.modulosSB.SBCore.TratamentoDeErros.ErroSB;
import java.io.Serializable;
import java.lang.reflect.Field;
import java.util.ArrayList;
import java.util.List;
import java.util.Map;
import javax.persistence.EntityManager;
import javax.persistence.Id;
import javax.persistence.ManyToOne;
import javax.persistence.OneToMany;

public abstract class EntidadeGenerica extends ItemGenerico implements Serializable {

    protected Field searchCampoIdentificacao() {

        System.out.println(this.getClass());
        Field[] fields = getClasseModelo().getDeclaredFields();

        for (Field field : fields) {
            Id annotationField = field.getAnnotation(Id.class);

            if (annotationField != null) {
                return field;
            }
        }

        return null;
    }

    @Override
    protected void adcionaCampoEsperado(CampoEsperado pCampo) {
        Field campo;
        if (pCampo.equals("id")) {
            campo = searchCampoIdentificacao();
            pCampo.setAnotacaoObrigatoria(true);
        } else {
            super.adcionaCampoEsperado(pCampo);
        }
    }

    public List<CampoMultiplo> getLookupMultuplo() {
        List<CampoMultiplo> resp = new ArrayList<CampoMultiplo>();
        for (Field campo : getCamposUmParaMuitos()) {
            try {
                campo.setAccessible(true);
                //Object teste = campo.get(this);
                CampoMultiplo novoCampo = new CampoMultiplo(campo, "teste",
                        campo.get(this));
                resp.add(novoCampo);

            } catch (IllegalArgumentException e) {

                e.printStackTrace();
            } catch (IllegalAccessException e) {

                e.printStackTrace();
            }

        }
        return resp;
    }

    protected EntityManager getEm() {
        return UtilSBPersistencia.getNovoEM();
        //BeansUtil.getAppBean("dados")).getEm();
    }

    public void loadByID(int pId) {

        Object resultado = UtilSBPersistencia.getRegistroByID(this.getClass(), pId);
        System.out.println("ATENÇÃO O METODO LOAD BY ID AINDA NÃO SUPORTA CLASSES COM POLIMORFISMO DE ENTIDADE");
        //todo compativel com Extenção de classe
        if (resultado != null) {
            copiaDados(resultado);
        }

    }

    public static Object createByID(int pId) {
        Class currentClass = new Object() {
        }.getClass().getEnclosingClass();
        System.out.println("classe clinica" + currentClass.getSimpleName());

        // return UtilSBPersistencia.getRegistroByID(currentClass, pId);
        throw new UnsupportedOperationException("Recurso para criar entidade via reflexão ainda não foi desenvolvido, motivo:"
                + "this.getClass não é suportado,  gabiarras precisam ser descobertas para obter a classe e vai ser nescessário "
                + " adcionar o loadByID na interface de entidade ");

    }

    protected EntidadeGenerica() {
        super();
    }

    protected static List<Field> getCamposUmParaMuitos() {
        List<Field> resposta = new ArrayList<Field>();
        Field[] fields = getClasseModelo().getDeclaredFields();

        for (Field field : fields) {
            OneToMany campoAnotado = field.getAnnotation(OneToMany.class);

            if (campoAnotado != null) {
                resposta.add(field);
            }
        }
        return resposta;
    }

    protected static List<Field> getCamposMuitosParaUm() {
        List<Field> resposta = new ArrayList<Field>();
        Field[] fields = getClasseModelo().getDeclaredFields();

        for (Field field : fields) {
            ManyToOne campoAnotado = field.getAnnotation(ManyToOne.class);
            if (campoAnotado != null) {
                resposta.add(field);
            }
        }
        return resposta;
    }

    @Override
    public void MakeCamposEncontrados() {
        super.MakeCamposEncontrados();

        Map<String, Field> mapEncontrados = analyze(this);

        for (String teste : mapEncontrados.keySet()) {
            Field campoEncontrado = mapEncontrados.get(teste);
            OneToMany anotacaoUmParaMuitos = campoEncontrado.getAnnotation(OneToMany.class);
            ManyToOne anotacaoMuitosParaUm = campoEncontrado.getAnnotation(ManyToOne.class);

            if (anotacaoUmParaMuitos != null) {
                // TODO cria campo de multiplas Seleções
                try {
                    CampoMultiplo novoCp = new CampoMultiplo(campoEncontrado,
                            "", campoEncontrado.get(this));
                    camposEncontrados.add(novoCp);
                } catch (IllegalArgumentException | IllegalAccessException e) {

                    SBCore.RelatarErro(ErroSB.TIPO_ERRO.ALERTA_PROGRAMADOR, "Erro tentando Ler Campos para montar os campos encontrados");
                }

            } else if (anotacaoMuitosParaUm != null) {
                // TODO cria campo de selecao de valor

            } else {

            }
        }
    }

}
